{"version":3,"file":"CMCDProxy.js","sourceRoot":"","sources":["../src/CMCDProxy.ts"],"names":[],"mappings":"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","sourcesContent":["import NativeVideoModule from './NativeVideoModule';\n\n/**\n * CMCD (Common Media Client Data) data structure for generating headers.\n * Based on CTA-5004 specification.\n */\nexport type CmcdData = {\n  /**\n   * Session ID - A unique string identifying the current playback session.\n   */\n  sid?: string;\n\n  /**\n   * Content ID - A unique string identifying the current content.\n   */\n  cid?: string;\n\n  /**\n   * Encoded bitrate - The encoded bitrate of the audio/video object being requested (kbps).\n   */\n  br?: number;\n\n  /**\n   * Object duration - The playback duration of the object being requested (milliseconds).\n   */\n  d?: number;\n\n  /**\n   * Object type - The type of object being requested:\n   * - 'm' = manifest\n   * - 'a' = audio only\n   * - 'v' = video only\n   * - 'av' = muxed audio/video\n   * - 'i' = init segment\n   * - 'c' = caption/subtitle\n   * - 'k' = encryption key\n   * - 'o' = other\n   */\n  ot?: 'm' | 'a' | 'v' | 'av' | 'i' | 'c' | 'k' | 'o';\n\n  /**\n   * Top bitrate - The highest bitrate rendition available (kbps).\n   */\n  tb?: number;\n\n  /**\n   * Buffer length - The buffer length in milliseconds.\n   */\n  bl?: number;\n\n  /**\n   * Deadline - The time remaining until rebuffer (milliseconds).\n   */\n  dl?: number;\n\n  /**\n   * Measured throughput - The throughput between client and server (kbps).\n   */\n  mtp?: number;\n\n  /**\n   * Next object request - Relative path of the next object to be requested.\n   */\n  nor?: string;\n\n  /**\n   * Next range request - Byte range of the next object.\n   */\n  nrr?: string;\n\n  /**\n   * Startup - true if the object is needed urgently due to startup/seek/recovery.\n   */\n  su?: boolean;\n\n  /**\n   * Buffer starvation - true if a rebuffering event occurred.\n   */\n  bs?: boolean;\n\n  /**\n   * Playback rate - 1 = real-time, 2 = double speed, 0 = not playing.\n   */\n  pr?: number;\n\n  /**\n   * Stream format - The streaming format:\n   * - 'd' = DASH\n   * - 'h' = HLS\n   * - 's' = Smooth Streaming\n   * - 'o' = other\n   */\n  sf?: 'd' | 'h' | 's' | 'o';\n\n  /**\n   * Stream type - 'v' = VOD, 'l' = live.\n   */\n  st?: 'v' | 'l';\n\n  /**\n   * Version - CMCD version (default is 1).\n   */\n  v?: number;\n\n  /**\n   * Requested maximum throughput - The requested maximum throughput (kbps).\n   */\n  rtp?: number;\n};\n\n/**\n * Formats CMCD data into HTTP headers according to CTA-5004 specification.\n * Returns headers in the four standard CMCD header format:\n * - CMCD-Object: Object-related keys (br, d, ot, tb)\n * - CMCD-Request: Request-related keys (bl, dl, mtp, nor, nrr, su)\n * - CMCD-Session: Session-related keys (cid, pr, sf, sid, st, v)\n * - CMCD-Status: Status-related keys (bs, rtp)\n *\n * @param data The CMCD data to format\n * @returns Record of header name to header value\n */\nexport function formatCmcdHeaders(data: CmcdData): Record<string, string> {\n  const headers: Record<string, string> = {};\n\n  const formatValue = (key: string, value: unknown): string => {\n    if (typeof value === 'boolean') {\n      return value ? key : '';\n    }\n    if (typeof value === 'string') {\n      // Strings need to be quoted, except for tokens (ot, sf, st)\n      if (['ot', 'sf', 'st'].includes(key)) {\n        return `${key}=${value}`;\n      }\n      return `${key}=\"${value}\"`;\n    }\n    if (typeof value === 'number') {\n      // Integers don't need decimal points\n      if (Number.isInteger(value)) {\n        return `${key}=${value}`;\n      }\n      return `${key}=${value.toFixed(0)}`;\n    }\n    return '';\n  };\n\n  // CMCD-Object: br, d, ot, tb\n  const objectParts: string[] = [];\n  if (data.br !== undefined) objectParts.push(formatValue('br', data.br));\n  if (data.d !== undefined) objectParts.push(formatValue('d', data.d));\n  if (data.ot !== undefined) objectParts.push(formatValue('ot', data.ot));\n  if (data.tb !== undefined) objectParts.push(formatValue('tb', data.tb));\n  if (objectParts.length > 0) {\n    headers['CMCD-Object'] = objectParts.filter(Boolean).join(',');\n  }\n\n  // CMCD-Request: bl, dl, mtp, nor, nrr, su\n  const requestParts: string[] = [];\n  if (data.bl !== undefined) requestParts.push(formatValue('bl', data.bl));\n  if (data.dl !== undefined) requestParts.push(formatValue('dl', data.dl));\n  if (data.mtp !== undefined) requestParts.push(formatValue('mtp', data.mtp));\n  if (data.nor !== undefined) requestParts.push(formatValue('nor', data.nor));\n  if (data.nrr !== undefined) requestParts.push(formatValue('nrr', data.nrr));\n  if (data.su !== undefined) requestParts.push(formatValue('su', data.su));\n  if (requestParts.length > 0) {\n    headers['CMCD-Request'] = requestParts.filter(Boolean).join(',');\n  }\n\n  // CMCD-Session: cid, pr, sf, sid, st, v\n  const sessionParts: string[] = [];\n  if (data.cid !== undefined) sessionParts.push(formatValue('cid', data.cid));\n  if (data.pr !== undefined) sessionParts.push(formatValue('pr', data.pr));\n  if (data.sf !== undefined) sessionParts.push(formatValue('sf', data.sf));\n  if (data.sid !== undefined) sessionParts.push(formatValue('sid', data.sid));\n  if (data.st !== undefined) sessionParts.push(formatValue('st', data.st));\n  if (data.v !== undefined) sessionParts.push(formatValue('v', data.v));\n  if (sessionParts.length > 0) {\n    headers['CMCD-Session'] = sessionParts.filter(Boolean).join(',');\n  }\n\n  // CMCD-Status: bs, rtp\n  const statusParts: string[] = [];\n  if (data.bs !== undefined) statusParts.push(formatValue('bs', data.bs));\n  if (data.rtp !== undefined) statusParts.push(formatValue('rtp', data.rtp));\n  if (statusParts.length > 0) {\n    headers['CMCD-Status'] = statusParts.filter(Boolean).join(',');\n  }\n\n  return headers;\n}\n\n/**\n * Generates a random session ID suitable for CMCD.\n * Returns a UUID v4 format string.\n *\n * @returns A unique session identifier string\n */\nexport function generateSessionId(): string {\n  // Generate UUID v4\n  const hex = '0123456789abcdef';\n  let uuid = '';\n  for (let i = 0; i < 36; i++) {\n    if (i === 8 || i === 13 || i === 18 || i === 23) {\n      uuid += '-';\n    } else if (i === 14) {\n      uuid += '4'; // Version 4\n    } else if (i === 19) {\n      uuid += hex[(Math.random() * 4) | 8]; // Variant bits\n    } else {\n      uuid += hex[(Math.random() * 16) | 0];\n    }\n  }\n  return uuid;\n}\n\n/**\n * API for controlling the local HTTP proxy used for dynamic header injection.\n * The proxy intercepts video segment requests and adds custom headers.\n */\nexport const CMCDProxy = {\n  /**\n   * Starts the local HTTP proxy server.\n   * This method is async and resolves when the proxy is ready to accept connections.\n   *\n   * @returns Promise that resolves when the proxy is running\n   * @platform android\n   * @platform ios\n   */\n  async start(): Promise<void> {\n    return NativeVideoModule.startCMCDProxy();\n  },\n\n  /**\n   * Stops the local HTTP proxy server.\n   *\n   * @platform android\n   * @platform ios\n   */\n  stop(): void {\n    NativeVideoModule.stopCMCDProxy();\n  },\n\n  /**\n   * Checks if the proxy server is currently running.\n   *\n   * @returns true if the proxy is running and accepting connections\n   * @platform android\n   * @platform ios\n   */\n  isRunning(): boolean {\n    return NativeVideoModule.isCMCDProxyRunning();\n  },\n\n  /**\n   * Gets the port number the proxy is listening on.\n   *\n   * @returns The port number, or 0 if the proxy is not running\n   * @platform android\n   * @platform ios\n   */\n  getPort(): number {\n    return NativeVideoModule.getCMCDProxyPort();\n  },\n\n  /**\n   * Gets the base URL for the proxy server.\n   *\n   * @returns The base URL (e.g., \"http://127.0.0.1:8080\") or null if not running\n   * @platform android\n   * @platform ios\n   */\n  getBaseUrl(): string | null {\n    const port = NativeVideoModule.getCMCDProxyPort();\n    if (port === 0) return null;\n    return `http://127.0.0.1:${port}`;\n  },\n\n  /**\n   * Creates a proxy URL for the given original URL.\n   * The proxy URL will route through the local proxy server.\n   *\n   * @param originalUrl The original video URL to proxy\n   * @returns The proxy URL, or null if the proxy is not running\n   * @platform android\n   * @platform ios\n   */\n  createProxyUrl(originalUrl: string): string | null {\n    const port = NativeVideoModule.getCMCDProxyPort();\n    if (port === 0) return null;\n    const encoded = encodeURIComponent(originalUrl);\n    return `http://127.0.0.1:${port}/proxy?url=${encoded}`;\n  },\n\n  /**\n   * Sets static headers that will be added to all proxied requests.\n   * These headers are in addition to any dynamic headers set on the VideoPlayer.\n   *\n   * @param headers Record of header names to values\n   * @platform android\n   * @platform ios\n   */\n  setStaticHeaders(headers: Record<string, string>): void {\n    NativeVideoModule.setCMCDProxyStaticHeaders(headers);\n  },\n};\n"]}